# -*- coding: utf-8 -*-
"""
Tkinter -> genera un HTML autocontenido (sin capa base) que:
- Embebe GeoJSON del SHP
- Embebe XLSX (SheetJS) y html2canvas (ambas inline, sin red)
- Carga XLSX (col1=cod_mun, col2=nivel 1-3)
- Etiqueta con MPIO_CNMBR
- Exporta SOLO el mapa (mapa+leyenda) a PNG transparente al zoom indicado
Requisitos: pip install geopandas
"""

import tkinter as tk
from tkinter import ttk, filedialog, messagebox
import geopandas as gpd

APP_TITLE = "Generar HTML (export PNG transparente solo mapa)"
DEFAULT_HTML_NAME = "mapa_export_transparente.html"

def build_html(geojson_text: str, xlsx_js_inline: str, h2c_js_inline: str) -> str:
    tpl = r'''<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Municipios por nivel (1-3)</title>

<!-- Leaflet (motor; sin tiles) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- XLSX (SheetJS) inline -->
<script>
__XLSX_INLINE__
</script>

<!-- html2canvas inline -->
<script>
__H2C_INLINE__
</script>

<style>
  html,body{height:100%;margin:0;background:#0b0f14;color:#e9eef5;font-family:Arial,Helvetica,sans-serif}
  .app{display:grid;grid-template-columns:360px 1fr;grid-template-rows:auto 1fr;height:100%}
  header{grid-column:1/3;background:#0d141d;border-bottom:1px solid #1f2a38;padding:10px 16px}
  header h1{margin:0;font-size:16px;font-weight:600}
  aside{background:#121821;border-right:1px solid #1f2a38;padding:14px;overflow:auto}
  label{display:block;font-size:12px;color:#8aa0b8;margin-bottom:6px}
  input[type="file"], input[type="number"], select, button{
    width:100%;padding:8px;background:#0f1621;color:#e9eef5;border:1px solid #273447;border-radius:8px
  }
  main{position:relative;overflow:hidden;} /* <- recorta SOLO al mapa en export */
  #map{height:100%;width:100%;background:#0b0f14}
  .legend{position:absolute;right:12px;bottom:12px;background:#0f1621d9;padding:10px 12px;border-radius:10px;border:1px solid #273447;font-size:12px}
  .swatch{display:inline-block;width:14px;height:14px;border-radius:4px;border:1px solid #0006;margin-right:6px;vertical-align:-3px}
  .note{font-size:12px;color:#a7b9cf;margin-top:6px}
  .mun-label{
    background:transparent;border:none;box-shadow:none;color:#e9eef5;
    font-size:11px;font-weight:600;text-shadow:0 0 2px #000, 0 0 4px #000;
    white-space:nowrap;pointer-events:none;
  }
  .row{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<div class="app">
  <header><h1>Municipios por nivel (1-3)</h1></header>

  <aside>
    <label>Suba el XLSX (Columna 1 = cod_mun, Columna 2 = nivel 1-3)</label>
    <input id="xlsxFile" type="file" accept=".xlsx,.xls" />

    <div class="note" style="margin-top:10px">Exportar PNG (solo mapa) con fondo transparente:</div>
    <div class="row" style="margin-top:6px">
      <div style="flex:1">
        <label>Nivel de zoom</label>
        <input id="zoomInput" type="number" min="0" max="20" step="1" value="6" />
      </div>
      <div style="flex:1">
        <label>Escala</label>
        <select id="scaleInput">
          <option value="1">1x</option>
          <option value="2" selected>2x</option>
          <option value="3">3x</option>
          <option value="4">4x</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <button id="btnPreviewZoom">Ir a zoom</button>
      <button id="btnExportPNG">Exportar PNG transparente (solo mapa)</button>
    </div>

    <div id="status" class="note" style="margin-top:10px"></div>
  </aside>

  <main>
    <div id="map"></div>
    <div class="legend" id="legend" hidden>
      <div><span class="swatch" id="sw1"></span> Nivel 1 (Alto)</div>
      <div><span class="swatch" id="sw2"></span> Nivel 2 (Medio)</div>
      <div><span class="swatch" id="sw3"></span> Nivel 3 (Bajo)</div>
      <hr style="border:none;border-top:1px solid #273447; margin:6px 0">
      <div><span class="swatch" style="background:#9aa7b6"></span> Sin dato</div>
    </div>
  </main>
</div>

<script>
// ---------- Datos embebidos ----------
const MUNICIPIOS_GEOJSON = __GEOJSON_PLACEHOLDER__;

// ---------- Utilidades ----------
function normCode(v){
  if(v===undefined || v===null) return "";
  const d = String(v).replace(/\D/g, "");
  if(!d) return "";
  return d.padStart(5,"0");
}
function palette(){ return {1:"#E74C3C", 2:"#F1C40F", 3:"#27AE60", other:"#9aa7b6"}; }
function detectNameProp(p){ return p.MPIO_CNMBR || p.NOMBRE_MPI || p.NOM_MPIO || p.MPIO || p.NAME || "Municipio"; }
function detectCodeProp(geojson){
  const feats = geojson.features || [];
  for(const f of feats){ if(f?.properties?.MPIO_CDPMP!==undefined) return "MPIO_CDPMP"; }
  for(const f of feats){ if(f?.properties?.cod_mun!==undefined) return "cod_mun"; }
  for(const f of feats){
    if(!f || !f.properties) continue;
    for(const k of Object.keys(f.properties)){
      const v = f.properties[k]; if(v==null) continue;
      if(typeof v==="string" || typeof v==="number") return k;
    }
  }
  return "MPIO_CDPMP";
}

// ---------- Mapa (sin base) ----------
const map = L.map("map",{zoomControl:true});
let gjLayer=null;
const legend = document.getElementById("legend");
const sw1 = document.getElementById("sw1"), sw2 = document.getElementById("sw2"), sw3 = document.getElementById("sw3");
(function initLegend(){
  const pal = palette(); sw1.style.background=pal[1]; sw2.style.background=pal[2]; sw3.style.background=pal[3];
  legend.hidden=false;
})();

const statusEl = document.getElementById("status");

function drawLayer(out){
  if(gjLayer){ gjLayer.remove(); }
  const pal = palette();
  gjLayer = L.geoJSON(out,{
    style: f => {
      const n = f.properties.nivel;
      return { color:"#000", weight:0.6, opacity:0.8, fillColor:(n? pal[n] : pal.other), fillOpacity:0.9 };
    },
    onEachFeature: (feat, layer) =>{
      const p = feat.properties || {};
      const name = detectNameProp(p);
      layer.bindTooltip(String(name), { permanent:true, direction:"center", className:"mun-label", opacity:1.0 });
      const code = p.cod_norm || "", n = (p.nivel==null? "Sin dato" : p.nivel);
      layer.bindPopup(`<b>${name}</b><br/>Código: ${code}<br/>Nivel: ${n}`);
    }
  }).addTo(map);
  try{ map.fitBounds(gjLayer.getBounds(), {padding:[12,12]}); }catch(_){}
}

// ---------- Carga XLSX ----------
document.getElementById("xlsxFile").addEventListener("change", e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    try{
      const data = new Uint8Array(ev.target.result);
      const wb = XLSX.read(data,{type:"array"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws,{header:1, defval:null});
      if(!rows.length){ statusEl.textContent="La hoja está vacía."; return; }
      const nCols = Math.max(...rows.map(r=>r.length));
      if(nCols < 2){ statusEl.textContent="Se requieren 2 columnas: cod_mun y nivel."; return; }

      const pares=[];
      for(let i=0;i<rows.length;i++){
        const cod = normCode(rows[i][0]);
        const niv = Number(String(rows[i][1]??"").trim());
        if(cod && (niv===1 || niv===2 || niv===3)){ pares.push([cod, niv]); }
      }
      if(!pares.length){ statusEl.textContent="No se encontraron filas válidas (cod_mun y nivel 1-3)."; return; }

      const idx = new Map(pares);
      const out = JSON.parse(JSON.stringify(MUNICIPIOS_GEOJSON));
      const codeProp = detectCodeProp(out);
      let unidos=0;
      out.features.forEach(f=>{
        const raw = f.properties ? f.properties[codeProp] : "";
        const code = normCode(raw);
        const niv = idx.get(code);
        if(niv===1 || niv===2 || niv===3) unidos++;
        f.properties = Object.assign({}, f.properties||{}, {cod_norm:code, nivel:(niv==null? null:niv)});
      });

      drawLayer(out);
      statusEl.textContent = `Unidos ${unidos} municipios con nivel (de ${out.features.length}).`;
    }catch(err){
      console.error(err);
      statusEl.textContent = "Error leyendo el XLSX: " + err.message;
    }
  };
  reader.readAsArrayBuffer(file);
});

// ---------- Controles de zoom y export ----------
const zoomInput  = document.getElementById("zoomInput");
const scaleInput = document.getElementById("scaleInput");
document.getElementById("btnPreviewZoom").addEventListener("click", ()=>{
  const z = parseInt(zoomInput.value,10); if(Number.isFinite(z)) map.setZoom(z);
});

document.getElementById("btnExportPNG").addEventListener("click", ()=>{
  const z = parseInt(zoomInput.value,10);
  const userScale = parseInt(scaleInput.value,10) || 2;
  exportOnlyMap(z, userScale);
});

function exportOnlyMap(targetZoom, userScale){
  const mainNode = document.querySelector("main");
  const mapEl = document.getElementById("map");
  const afterZoom = ()=>{
    const prevBg = mapEl.style.background;
    mapEl.style.background = "transparent";
    const deviceScale = (window.devicePixelRatio || 1);
    const h2cScale = deviceScale * userScale;

    html2canvas(mainNode, {
      backgroundColor: null,    // <- transparencia real (doc oficial)
      useCORS: true,
      allowTaint: true,
      scale: h2cScale
    }).then(canvas=>{
      const a = document.createElement("a");
      a.download = `mapa_niveles_z${map.getZoom()}_${h2cScale}x.png`;
      a.href = canvas.toDataURL("image/png");
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      mapEl.style.background = prevBg || "";
    }).catch(err=>{
      alert("No se pudo generar la imagen: " + err.message);
      mapEl.style.background = prevBg || "";
    });
  };

  if(Number.isFinite(targetZoom) && map.getZoom() !== targetZoom){
    map.once("zoomend", afterZoom);
    map.setZoom(targetZoom);
  } else {
    afterZoom();
  }
}

// Dibujo inicial (sin nivel) para ver etiquetas desde el inicio
(function(){ const out = JSON.parse(JSON.stringify(MUNICIPIOS_GEOJSON)); drawLayer(out); })();
</script>
</body>
</html>
'''
    h = tpl.replace("__GEOJSON_PLACEHOLDER__", geojson_text)
    h = h.replace("__XLSX_INLINE__", xlsx_js_inline)
    h = h.replace("__H2C_INLINE__", h2c_js_inline)
    return h

class App(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title(APP_TITLE)
        self.geometry("820x320")
        self.gdf = None
        self.xlsx_js = None
        self.h2c_js = None
        self.path_shp = tk.StringVar()
        self.path_xlsx = tk.StringVar()
        self.path_h2c = tk.StringVar()
        self._build()

    def _build(self):
        pad = {"padx":10, "pady":6}
        ttk.Label(self, text="1) Selecciona el SHP de municipios (EPSG:4326 recomendado):",
                  font=("Segoe UI",10,"bold")).grid(row=0, column=0, columnspan=4, sticky="w", **pad)
        ttk.Entry(self, textvariable=self.path_shp, width=60).grid(row=1, column=0, columnspan=3, sticky="we", **pad)
        ttk.Button(self, text="Buscar SHP...", command=self.load_shp).grid(row=1, column=3, sticky="we", **pad)

        ttk.Label(self, text="2) Selecciona xlsx.full.min.js (SheetJS) para embeber:",
                  font=("Segoe UI",10,"bold")).grid(row=2, column=0, columnspan=4, sticky="w", **pad)
        ttk.Entry(self, textvariable=self.path_xlsx, width=60).grid(row=3, column=0, columnspan=3, sticky="we", **pad)
        ttk.Button(self, text="Buscar JS XLSX...", command=self.load_xlsx_js).grid(row=3, column=3, sticky="we", **pad)

        ttk.Label(self, text="3) Selecciona html2canvas.min.js para embeber:",
                  font=("Segoe UI",10,"bold")).grid(row=4, column=0, columnspan=4, sticky="w", **pad)
        ttk.Entry(self, textvariable=self.path_h2c, width=60).grid(row=5, column=0, columnspan=3, sticky="we", **pad)
        ttk.Button(self, text="Buscar html2canvas...", command=self.load_h2c_js).grid(row=5, column=3, sticky="we", **pad)

        ttk.Button(self, text="4) Generar HTML (solo mapa, PNG transparente)...", command=self.generate_html)\
            .grid(row=6, column=0, columnspan=4, sticky="we", **pad)

    def load_shp(self):
        path = filedialog.askopenfilename(title="Selecciona shapefile (.shp)",
                                          filetypes=[("Shapefile","*.shp"), ("Todos","*.*")])
        if not path: return
        try:
            gdf = gpd.read_file(path)
            if gdf.empty: raise ValueError("La capa está vacía.")
            try:
                if gdf.crs is not None and gdf.crs.to_epsg() != 4326:
                    gdf = gdf.to_crs(epsg=4326)
            except Exception:
                pass
            self.gdf = gdf
            self.path_shp.set(path)
            messagebox.showinfo("Listo", f"Capa cargada con {len(gdf)} entidades.")
        except Exception as e:
            messagebox.showerror("Error", f"No se pudo cargar el SHP:\n{e}")

    def load_xlsx_js(self):
        path = filedialog.askopenfilename(title="Selecciona xlsx.full.min.js",
                                          filetypes=[("JavaScript","*.js"), ("Todos","*.*")])
        if not path: return
        try:
            with open(path, "r", encoding="utf-8") as f:
                self.xlsx_js = f.read()
            self.path_xlsx.set(path)
            if "XLSX" not in self.xlsx_js:
                messagebox.showwarning("Atención","El archivo no parece ser SheetJS (XLSX).")
        except Exception as e:
            messagebox.showerror("Error", f"No se pudo leer el JS:\n{e}")

    def load_h2c_js(self):
        path = filedialog.askopenfilename(title="Selecciona html2canvas.min.js",
                                          filetypes=[("JavaScript","*.js"), ("Todos","*.*")])
        if not path: return
        try:
            with open(path, "r", encoding="utf-8") as f:
                self.h2c_js = f.read()
            self.path_h2c.set(path)
            if "html2canvas" not in self.h2c_js:
                messagebox.showwarning("Atención","El archivo no parece ser html2canvas.")
        except Exception as e:
            messagebox.showerror("Error", f"No se pudo leer el JS:\n{e}")

    def generate_html(self):
        if self.gdf is None:
            messagebox.showwarning("Atención", "Carga primero el SHP."); return
        if not self.xlsx_js:
            messagebox.showwarning("Atención", "Selecciona xlsx.full.min.js."); return
        if not self.h2c_js:
            messagebox.showwarning("Atención", "Selecciona html2canvas.min.js."); return

        gj_text = self.gdf.to_json()
        out_path = filedialog.asksaveasfilename(title="Guardar HTML",
                        defaultextension=".html", initialfile=DEFAULT_HTML_NAME,
                        filetypes=[("HTML","*.html")])
        if not out_path: return
        try:
            html = build_html(gj_text, self.xlsx_js, self.h2c_js)
            with open(out_path, "w", encoding="utf-8") as f:
                f.write(html)
            messagebox.showinfo("Hecho",
                "HTML creado:\n" + out_path +
                "\n\nÁbrelo en el navegador, sube el XLSX y usa 'Exportar PNG transparente (solo mapa)'.")
        except Exception as e:
            messagebox.showerror("Error", "No se pudo crear el HTML:\n" + str(e))

if __name__ == "__main__":
    app = App()
    app.mainloop()
